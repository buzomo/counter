<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>â±ï¸</text></svg>" />
    <title>ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ãƒ»ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—</title>
    <style>
        .container {
            max-width: 1280px;
            margin: 0 auto;
            padding: 12px;
        }

        :root {
            --primary: #4e6cf2;
            --primary-hover: #3c53d6;
            --text: #333;
            --bg: #f5f7fa;
            --card-bg: #fff;
            --border: #e2e8f0;
            --shadow: rgba(0, 0, 0, 0.05);
            --shadow-hover: rgba(0, 0, 0, 0.08);
            --radius: 12px;
            --transition: all 0.2s ease;
            --countdown: #ff7e5f;
            --countup: #5fa3ff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-weight: bold;
            font-size: 18px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            max-width: 100%;
            width: 100%;
            margin: 0 auto;
        }

        .composer {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: 0 2px 8px var(--shadow);
        }

        input {
            color: #2d6286;
        }

        input[type="text"],
        input[type="date"] {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            transition: var(--transition);
            font-family: inherit;
        }

        input[type="text"]:focus,
        input[type="date"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(78, 108, 242, 0.2);
        }

        select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            transition: var(--transition);
            font-family: inherit;
            margin-bottom: 10px;
            background-color: white;
        }

        .btn {
            padding: 0.75rem 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
        }

        .btn:hover {
            background: var(--primary-hover);
        }

        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            color: #4a5568;
        }

        #counters {
            display: grid;
            gap: 12px;
            grid-template-columns: 1fr;
            padding-top: 8px;
        }

        @media (min-width: 640px) {
            #counters {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 960px) {
            #counters {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (min-width: 1280px) {
            #counters {
                grid-template-columns: repeat(5, 1fr);
            }
        }

        .counter {
            position: relative;
            padding: 16px;
            border-radius: var(--radius);
            background: var(--card-bg);
            box-shadow: 0 2px 5px var(--shadow);
            transition: var(--transition);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .counter:hover {
            box-shadow: 0 5px 15px var(--shadow-hover);
            transform: translateY(-2px);
        }

        .counter-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2d3748;
        }

        .counter-date {
            font-size: 0.9rem;
            color: #718096;
        }

        .counter-value {
            font-size: 1.8rem;
            font-weight: bold;
        }

        .countdown .counter-value {
            color: var(--countdown);
        }

        .countup .counter-value {
            color: var(--countup);
        }

        .counter-unit {
            font-size: 0.9rem;
            color: #718096;
        }

        .counter-actions {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 8px;
        }

        .counter-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            color: #a0aec0;
            transition: var(--transition);
        }

        .counter-btn:hover {
            color: var(--primary);
        }

        #token-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(250, 250, 255, 0.95);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #token-overlay input {
            padding: 0.5rem;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 6px;
            width: 300px;
            max-width: 80%;
            margin-bottom: 1rem;
        }

        #token-overlay button {
            padding: 0.5rem 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
        }

        .tab-controls {
            display: flex;
            border-radius: var(--radius);
            overflow: hidden;
            background: #e2e8f0;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            transition: var(--transition);
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
        }

        .counter-note {
            font-size: 0.9rem;
            margin-top: 10px;
            color: #718096;
            font-style: italic;
        }

        .progress-bar {
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .countdown .progress-fill {
            background: var(--countdown);
        }

        .countup .progress-fill {
            background: var(--countup);
        }

        .counter.expired {
            opacity: 0.6;
        }

        .counter-info-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 12px;
            gap: 8px;
        }

        .counter-info-left {
            text-align: left;
            flex: 1;
            color: #718096;
            font-size: 0.95rem;
            white-space: nowrap;
        }

        .counter-info-right {
            text-align: right;
            flex: 1;
            color: #718096;
            font-size: 0.95rem;
            white-space: nowrap;
        }

        #emoji-dock {
            position: fixed;
            left: 50%;
            bottom: 32px;
            transform: translateX(-50%);
            display: flex;
            gap: 24px;
            background: rgba(16, 185, 129, 0.185);
            /* ã‚¨ãƒ¡ãƒ©ãƒ«ãƒ‰ã‚«ãƒ©ãƒ¼ */
            border-radius: 20px;
            backdrop-filter: blur(12px);
            /* èƒŒæ™¯ã‚’ã¼ã‹ã™ */
            box-shadow: 2px 10px 16px rgba(181, 204, 200, 0.8);
            padding: 8px 22px;
            z-index: 9998;
            height: 54px;
            align-items: center;
        }

        #emoji-dock a {
            font-size: 1.9rem;
            text-decoration: none;
            transition: transform 0.15s, filter 0.15s;
            filter: grayscale(0.2);
            user-select: none;
        }

        #emoji-dock a:hover {
            transform: scale(1.25) translateY(-8px);
            filter: grayscale(0) drop-shadow(0 2px 8px #4e6cf2aa);
        }
    </style>
</head>

<body>
    <a href="https://github.com/buzomo/counter/edit/main/index.html"
        style="text-decoration:none;position:fixed;right:13px;bottom:0;color:orange">edit now</a>
    <div id="token-overlay" style="display: none;">
        <input type="password" id="token-input" placeholder="GitHub Token ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" />
        <button onclick="submitToken()">ä¿å­˜ã—ã¦ãƒªãƒ­ãƒ¼ãƒ‰</button>
    </div>
    <div class="container">


        <div id="view-content">
            <div class="composer">
                <input id="searchBox" type="text" placeholder="æ¤œç´¢..." />
            </div>
            <div id="counters"></div>
            <div id="add-content" style="display: none;">
                <div class="composer">
                    <div class="form-group">
                        <label for="counter-title">ã‚¿ã‚¤ãƒˆãƒ«</label>
                        <input type="text" id="counter-title" placeholder="ã‚µãƒ–ã‚¹ã‚¯åã‚„è¨˜å¿µæ—¥ãªã©" />
                    </div>
                    <div class="form-group">
                        <label for="counter-date">æ—¥ä»˜</label>
                        <input type="date" id="counter-date" />
                    </div>
                    <div class="form-group">
                        <label for="counter-note">ãƒ¡ãƒ¢ (ä»»æ„)</label>
                        <input type="text" id="counter-note" placeholder="ãƒ¡ãƒ¢ã‚’å…¥åŠ›..." />
                    </div>
                    <button class="btn" id="add-counter">è¿½åŠ ã™ã‚‹</button>
                </div>
            </div>
        </div>
        <div id="emoji-dock">
            <a href="https://è¨˜éŒ².ã¸.pw/" title="ãŠã‚Œã®æŸ">ğŸ—‚ï¸</a>
            <a href="https://ã‚«ã‚¦ãƒ³ãƒˆ.ã¸.pw/" title="ãƒ‡ã‚¤ã‚«ã‚¦ãƒ³ãƒˆ">â±ï¸</a>
            <a href="https://æ—¥è¨˜.ã¸.pw/" title="æ—¥è¨˜">ğŸ–Š</a>
            <a href="https://é‡‘.ã¸.pw/" title="ç¾é‡‘ç®¡ç†">ğŸ‘›</a>
        </div>
    </div>

    <script>
        // GitHub Token é–¢é€£
        if (!localStorage.getItem('gh_token')) {
            document.getElementById('token-overlay').style.display = 'flex';
            document.body.style.overflow = 'hidden';  // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«é˜²æ­¢
        }

        function submitToken() {
            const token = document.getElementById('token-input').value.trim();
            if (token) {
                localStorage.setItem('gh_token', token);
                location.reload();
            }
        }

        let gh_token = localStorage.getItem('gh_token');
        try {
            const parsed = JSON.parse(gh_token);
            if (parsed?.value) gh_token = parsed.value;
        } catch { }
        if (gh_token) localStorage.setItem('gh_token', gh_token);

        // APIã¨ãƒ‡ãƒ¼ã‚¿ã®è¨­å®š
        const apiUrl = 'https://api.github.com/repos/buzomo/bukome/contents/counter.json';
        let allCounters = [];
        // ã‚½ãƒ¼ãƒˆã¯å¸¸ã«ã€Œæ®‹æ—¥æ•°/çµŒéæ—¥æ•°é †ã€
        let currentSort = 'value';


        // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®èª­ã¿è¾¼ã¿
        async function loadCounters() {
            try {
                const res = await fetch(apiUrl, {
                    headers: {
                        Authorization: `Bearer ${gh_token}`
                    }
                });
                if (res.ok) {
                    const meta = await res.json();
                    // ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Œã°èª­ã¿è¾¼ã‚€
                    if (meta.content) {
                        const decoded = decodeURIComponent(escape(atob(meta.content)));
                        allCounters = JSON.parse(decoded);
                    } else {
                        // ãƒ•ã‚¡ã‚¤ãƒ«ãŒãªã‘ã‚Œã°ç©ºã®é…åˆ—
                        allCounters = [];
                    }
                } else {
                    if (res.status === 404) {
                        // ãƒ•ã‚¡ã‚¤ãƒ«ãŒå­˜åœ¨ã—ãªã„å ´åˆã¯ç©ºã®é…åˆ—
                        allCounters = [];
                    } else {
                        console.warn('èª­ã¿è¾¼ã¿å¤±æ•—:', await res.text());
                        allCounters = [];
                    }
                }
            } catch (e) {
                console.warn('èª­ã¿è¾¼ã¿å¤±æ•—:', e);
                allCounters = [];
            }

            // é‡è¤‡æ’é™¤å‡¦ç†
            if (Array.isArray(allCounters) && allCounters.length > 1) {
                const seen = new Set();
                const deduped = [];
                for (const c of allCounters) {
                    // ã‚­ãƒ¼ã¯ã‚¿ã‚¤ãƒˆãƒ«ãƒ»æ—¥ä»˜ãƒ»ãƒ¡ãƒ¢ï¼ˆnullã¯ç©ºæ–‡å­—ï¼‰
                    const key = `${c.title}__${c.date}__${c.note || ''}`;
                    if (!seen.has(key)) {
                        seen.add(key);
                        deduped.push(c);
                    }
                }
                if (deduped.length !== allCounters.length) {
                    allCounters = deduped;
                    // GitHubã®ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
                    await saveToGitHub(allCounters, true);
                }
            }

            renderCounters();
        }

        // GitHub ã«ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ï¼ˆ409ã‚¨ãƒ©ãƒ¼æ™‚ã¯å†å–å¾—ã—ã¦ãƒªãƒˆãƒ©ã‚¤ï¼‰
        async function saveToGitHub(data, skipRetryAdd = false) {
            let sha = null;
            try {
                const metaRes = await fetch(apiUrl, {
                    headers: { Authorization: `Bearer ${gh_token}` }
                });
                if (metaRes.ok) {
                    const meta = await metaRes.json();
                    sha = meta.sha;
                }
            } catch (e) {
                console.warn('shaå–å¾—å¤±æ•—:', e);
            }

            const body = {
                message: 'Update counters',
                content: btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))))
            };
            if (sha) body.sha = sha;

            try {
                const res = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        Authorization: `Bearer ${gh_token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                if (!res.ok) {
                    // 409ã‚¨ãƒ©ãƒ¼æ™‚ã¯1å›ã ã‘ãƒªãƒˆãƒ©ã‚¤
                    if (res.status === 409 && !skipRetryAdd) {
                        // æœ€æ–°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦å†åº¦è¿½åŠ ãƒ»ä¿å­˜
                        await loadCounters();
                        // ç›´å‰ã®è¿½åŠ åˆ†ãŒé‡è¤‡ã—ãªã„ã‚ˆã†ã«å†ãƒã‚§ãƒƒã‚¯
                        const title = document.getElementById('counter-title').value.trim();
                        const date = document.getElementById('counter-date').value;
                        const note = document.getElementById('counter-note').value.trim();
                        const exists = allCounters.some(c =>
                            c.title === title &&
                            c.date === date &&
                            (c.note || '') === note
                        );
                        if (!exists && title && date) {
                            // ã‚¿ã‚¤ãƒ—è‡ªå‹•åˆ¤åˆ¥
                            const type = detectCounterType(date);
                            allCounters.push({
                                title,
                                type,
                                date,
                                note: note || null,
                                created: new Date().toISOString()
                            });
                        }
                        return await saveToGitHub(allCounters, true);
                    } else {
                        // 409ä»¥å¤–ã‚„ãƒªãƒˆãƒ©ã‚¤å¾Œã¯ã‚¨ãƒ©ãƒ¼ã‚’é™ã‹ã«ç„¡è¦–
                        return false;
                    }
                }
                return true;
            } catch (e) {
                // ã‚¨ãƒ©ãƒ¼ã¯é™ã‹ã«ç„¡è¦–
                return false;
            }
        }

        // æ—¥ä»˜ã®å·®åˆ†è¨ˆç®—ï¼ˆæ—¥æ•°ï¼‰
        function getDaysDifference(dateStr) {
            const targetDate = new Date(dateStr);
            const today = new Date();

            // æ™‚é–“éƒ¨åˆ†ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¦ç´”ç²‹ã«æ—¥ä»˜ã ã‘ã‚’æ¯”è¼ƒ
            today.setHours(0, 0, 0, 0);
            targetDate.setHours(0, 0, 0, 0);

            const diffTime = targetDate - today;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        // æ—¥ä»˜ã®ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatDate(dateStr) {
            const d = new Date(dateStr);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const weekdays = ['æ—¥', 'æœˆ', 'ç«', 'æ°´', 'æœ¨', 'é‡‘', 'åœŸ'];
            const weekday = weekdays[d.getDay()];
            return `${year}å¹´${month}æœˆ${day}æ—¥(${weekday})`;
        }

        // æ—¥æ•°ã‚’ã€Œyå¹´mãƒ¶æœˆã€ã¾ãŸã¯ã€Œmãƒ¶æœˆdæ—¥ã€å½¢å¼ã§ãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆ
        function formatYearMonthDay(days) {
            const absDays = Math.abs(days);
            if (absDays < 31) {
                return `${absDays}æ—¥`;
            }
            const years = Math.floor(absDays / 365);
            const months = Math.floor((absDays % 365) / 30);
            const daysLeft = absDays - years * 365 - months * 30;
            if (years > 0) {
                let result = `${years}å¹´`;
                if (months > 0) result += `${months}ãƒ¶æœˆ`;
                return result;
            } else {
                let result = '';
                if (months > 0) result += `${months}ãƒ¶æœˆ`;
                if (daysLeft > 0) result += `${daysLeft}æ—¥`;
                return result;
            }
        }

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®è¨ˆç®—ï¼ˆã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ç”¨ï¼‰
        function calculateCountdownProgress(dateStr) {
            const targetDate = new Date(dateStr);
            const today = new Date();
            const createdDate = new Date();
            createdDate.setDate(today.getDate() - 30); // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã§30æ—¥å‰ã‹ã‚‰é–‹å§‹ã¨ä»®å®š

            const totalDays = Math.ceil((targetDate - createdDate) / (1000 * 60 * 60 * 24));
            const remainingDays = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));

            // å®Œäº†ã—ãŸå‰²åˆã‚’è¨ˆç®—ï¼ˆ0ï½100%ï¼‰
            return Math.min(100, Math.max(0, ((totalDays - remainingDays) / totalDays) * 100));
        }

        // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®è¨ˆç®—ï¼ˆã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—ç”¨ï¼‰
        function calculateCountupProgress(dateStr) {
            const startDate = new Date(dateStr);
            const today = new Date();
            const futureDate = new Date(startDate);
            futureDate.setFullYear(startDate.getFullYear() + 1); // 1å¹´å¾Œã‚’ã‚´ãƒ¼ãƒ«ã¨ä»®å®š

            const totalDays = Math.ceil((futureDate - startDate) / (1000 * 60 * 60 * 24));
            const passedDays = Math.ceil((today - startDate) / (1000 * 60 * 60 * 24));

            // å®Œäº†ã—ãŸå‰²åˆã‚’è¨ˆç®—ï¼ˆ0ï½100%ï¼‰
            return Math.min(100, Math.max(0, (passedDays / totalDays) * 100));
        }

        // ã‚¿ã‚¤ãƒ—è‡ªå‹•åˆ¤åˆ¥é–¢æ•°
        function detectCounterType(date) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const target = new Date(date);
            target.setHours(0, 0, 0, 0);
            // ä»Šæ—¥ã‚ˆã‚Šæœªæ¥â†’ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³ã€ä»Šæ—¥ã¾ãŸã¯éå»â†’ã‚«ã‚¦ãƒ³ãƒˆã‚¢ãƒƒãƒ—
            return target > today ? 'countdown' : 'countup';
        }

        // è¿½åŠ UIã®è¡¨ç¤ºåˆ¶å¾¡
        function showAddUI(defaultTitle = '') {
            const addContent = document.getElementById('add-content');
            addContent.style.display = 'block';
            document.getElementById('counter-title').value = defaultTitle;
            document.getElementById('counter-date').valueAsDate = new Date();
            document.getElementById('counter-note').value = '';
            // ãƒœã‚¿ãƒ³çŠ¶æ…‹ãƒªã‚»ãƒƒãƒˆ
            const addBtn = document.getElementById('add-counter');
            addBtn.textContent = 'è¿½åŠ ã™ã‚‹';
            addBtn.onclick = addCounter;
        }
        function hideAddUI() {
            document.getElementById('add-content').style.display = 'none';
        }

        // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼è¡¨ç¤º
        function renderCounters(filterText = '') {
            const container = document.getElementById('counters');
            container.innerHTML = '';
            hideAddUI();

            if (!Array.isArray(allCounters) || allCounters.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:2rem;color:#718096;">ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä¸‹è¨˜ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰è¿½åŠ ã—ã¦ãã ã•ã„ã€‚</div>';
                showAddUI(filterText);
                document.getElementById('searchBox').placeholder = 'æ¤œç´¢...ï¼ˆ0ä»¶ï¼‰';
                return;
            }

            // æ¤œç´¢ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼
            let filtered = allCounters.filter(counter => {
                return counter.title.includes(filterText) ||
                    (counter.note && counter.note.includes(filterText));
            });

            // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³æœŸé™è¶…éåˆ†ã¨ãã‚Œä»¥å¤–ã§åˆ†ã‘ã‚‹
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            let notExpired = [];
            let expired = [];
            filtered.forEach(counter => {
                if (
                    counter.type === 'countdown' &&
                    getDaysDifference(counter.date) < 0
                ) {
                    expired.push(counter);
                } else {
                    notExpired.push(counter);
                }
            });

            // ã‚½ãƒ¼ãƒˆ: notExpiredã¯é€šå¸¸ã®å€¤é †ã€expiredã¯æœŸé™è¶…éæ—¥æ•°ãŒå¤§ãã„é †
            notExpired.sort((a, b) => {
                const daysA = getDaysDifference(a.date);
                const daysB = getDaysDifference(b.date);

                if (a.type === 'countdown' && b.type === 'countdown') {
                    return daysA - daysB;
                } else if (a.type === 'countup' && b.type === 'countup') {
                    return daysB - daysA;
                } else if (a.type === 'countdown' && b.type === 'countup') {
                    return -1;
                } else {
                    return 1;
                }
            });
            expired.sort((a, b) => {
                // æœŸé™è¶…éæ—¥æ•°ãŒå¤§ãã„ã‚‚ã®ã»ã©å¾Œã‚
                return getDaysDifference(a.date) - getDaysDifference(b.date);
            });

            document.getElementById('searchBox').placeholder = `æ¤œç´¢...ï¼ˆå…¨${allCounters.length}ä»¶ï¼‰`;

            let displayList = notExpired.concat(expired);
            displayList.forEach((counter, idx) => {
                const daysDiff = getDaysDifference(counter.date);
                const counterClass = counter.type === 'countdown' ? 'countdown' : 'countup';
                const expiredClass = (counter.type === 'countdown' && daysDiff < 0) ? 'expired' : '';

                let displayText = '';
                let hoverText = `${Math.abs(daysDiff)}æ—¥`;
                const dateStr = formatDate(counter.date);

                let unitHtml = '';
                if (counter.type === 'countdown') {
                    unitHtml = `<div class="counter-unit counter-info-right">${dateStr}ã¾ã§</div>`;
                    if (daysDiff < 0) {
                        displayText = formatYearMonthDay(daysDiff);
                    } else if (daysDiff === 0) {
                        displayText = 'ä»Šæ—¥';
                    } else {
                        displayText = formatYearMonthDay(daysDiff);
                    }
                } else {
                    unitHtml = `<div class="counter-unit counter-info-left">${dateStr}ã‹ã‚‰</div>`;
                    if (daysDiff > 0) {
                        displayText = 'ã‚ã¨';
                    } else if (daysDiff === 0) {
                        displayText = 'ä»Šæ—¥';
                    } else {
                        displayText = formatYearMonthDay(daysDiff);
                    }
                }

                const progressPercent = counter.type === 'countdown'
                    ? calculateCountdownProgress(counter.date)
                    : calculateCountupProgress(counter.date);

                // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰åˆ¤å®š
                if (counter._editing) {
                    // ç·¨é›†UI
                    const div = document.createElement('div');
                    div.className = `counter ${counterClass} ${expiredClass}`;
                    div.innerHTML = `
                        <input class="edit-title" type="text" value="${counter.title.replace(/"/g, '&quot;')}" style="margin-bottom:8px;">
                        <input class="edit-date" type="date" value="${counter.date.split('T')[0]}" style="margin-bottom:8px;">
                        <input class="edit-note" type="text" value="${counter.note ? counter.note.replace(/"/g, '&quot;') : ''}" placeholder="ãƒ¡ãƒ¢" style="margin-bottom:8px;">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercent}%"></div>
                        </div>
                    `;
                    // Enterã§ä¿å­˜
                    const saveEdit = async (e) => {
                        if (e.type === 'keydown' && e.key !== 'Enter') return;
                        const newTitle = div.querySelector('.edit-title').value.trim();
                        const newDate = div.querySelector('.edit-date').value;
                        const newNote = div.querySelector('.edit-note').value.trim();
                        if (!newTitle || !newDate) return;

                        // å¤‰æ›´ãŒãªã‘ã‚Œã°ãã®ã¾ã¾é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã«æˆ»ã™
                        if (
                            newTitle === counter.title &&
                            newDate === counter.date &&
                            (newNote || null) === (counter.note || null)
                        ) {
                            delete allCounters[idx]._editing;
                            renderCounters(document.getElementById('searchBox').value.trim());
                            return;
                        }

                        // é‡è¤‡ãƒã‚§ãƒƒã‚¯ï¼ˆè‡ªåˆ†ä»¥å¤–ï¼‰
                        const exists = allCounters.some((c, i) =>
                            i !== idx &&
                            c.title === newTitle &&
                            c.date === newDate &&
                            (c.note || '') === newNote
                        );
                        if (exists) {
                            alert('åŒã˜å†…å®¹ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™');
                            return;
                        }
                        // æ›´æ–°
                        allCounters[idx] = {
                            ...counter,
                            title: newTitle,
                            date: newDate,
                            note: newNote || null,
                            type: detectCounterType(newDate),
                            updated: new Date().toISOString(),
                        };
                        delete allCounters[idx]._editing;
                        await saveToGitHub(allCounters, true);
                        renderCounters(document.getElementById('searchBox').value.trim());
                    };
                    div.querySelector('.edit-title').addEventListener('keydown', saveEdit);
                    div.querySelector('.edit-date').addEventListener('keydown', saveEdit);
                    div.querySelector('.edit-note').addEventListener('keydown', saveEdit);
                    // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹å¤–ã‚ŒãŸã‚‰ä¿å­˜
                    div.querySelector('.edit-title').addEventListener('blur', saveEdit);
                    div.querySelector('.edit-date').addEventListener('blur', saveEdit);
                    div.querySelector('.edit-note').addEventListener('blur', saveEdit);
                    container.appendChild(div);
                    return;
                }

                // é€šå¸¸è¡¨ç¤º
                const div = document.createElement('div');
                div.className = `counter ${counterClass} ${expiredClass}`;
                div.innerHTML = `
                    <div class="counter-title">${counter.title}</div>
                    <div class="counter-value" title="${hoverText}">${displayText}</div>
                    ${unitHtml}
                    ${counter.note ? `<div class="counter-note">${counter.note}</div>` : ''}
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercent}%"></div>
                    </div>
                `;
                // ãƒã‚¦ã‚¹ãƒ›ãƒãƒ¼ã§ä¸€æ™‚çš„ã«ãƒ†ã‚­ã‚¹ãƒˆã‚’ç½®ãæ›ãˆ
                const valueElem = div.querySelector('.counter-value');
                let originalText = displayText;
                div.addEventListener('mouseenter', () => {
                    if (valueElem) valueElem.textContent = hoverText;
                });
                div.addEventListener('mouseleave', () => {
                    if (valueElem) valueElem.textContent = originalText;
                });
                // å³ã‚¯ãƒªãƒƒã‚¯ã§å‰Šé™¤
                div.addEventListener('contextmenu', async (e) => {
                    e.preventDefault();
                    // idxã¯è¡¨ç¤ºãƒªã‚¹ãƒˆã®indexãªã®ã§ã€å…ƒé…åˆ—ã®indexã‚’ç‰¹å®š
                    const realIdx = allCounters.findIndex(c =>
                        c.title === counter.title &&
                        c.date === counter.date &&
                        (c.note || '') === (counter.note || '')
                    );
                    if (realIdx !== -1) {
                        allCounters.splice(realIdx, 1);
                        await saveToGitHub(allCounters, true);
                        renderCounters(document.getElementById('searchBox').value.trim());
                    }
                });
                // ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯ã§ç·¨é›†
                div.addEventListener('dblclick', () => {
                    // idxã¯è¡¨ç¤ºãƒªã‚¹ãƒˆã®indexãªã®ã§ã€å…ƒé…åˆ—ã®indexã‚’ç‰¹å®š
                    const realIdx = allCounters.findIndex(c =>
                        c.title === counter.title &&
                        c.date === counter.date &&
                        (c.note || '') === (counter.note || '')
                    );
                    if (realIdx !== -1) {
                        allCounters[realIdx]._editing = true;
                        renderCounters(document.getElementById('searchBox').value.trim());
                    }
                });
                container.appendChild(div);
            });

            if (filtered.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:2rem;color:#718096;">è©²å½“ã™ã‚‹ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚ä¸‹è¨˜ãƒ•ã‚©ãƒ¼ãƒ ã‹ã‚‰è¿½åŠ ã§ãã¾ã™ã€‚</div>';
                showAddUI(filterText);
            }
        }

        // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼è¿½åŠ 
        async function addCounter() {
            const addBtn = document.getElementById('add-counter');
            if (addBtn.disabled) return; // ã™ã§ã«å‡¦ç†ä¸­ãªã‚‰ä½•ã‚‚ã—ãªã„
            addBtn.disabled = true;

            try {
                const title = document.getElementById('counter-title').value.trim();
                const date = document.getElementById('counter-date').value;
                const note = document.getElementById('counter-note').value.trim();

                if (!title) {
                    alert('ã‚¿ã‚¤ãƒˆãƒ«ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
                    return;
                }

                if (!date) {
                    alert('æ—¥ä»˜ã‚’é¸æŠã—ã¦ãã ã•ã„');
                    return;
                }

                // æœ€æ–°ãƒ‡ãƒ¼ã‚¿å–å¾—ã—ã¦ã‹ã‚‰é‡è¤‡ãƒã‚§ãƒƒã‚¯
                await loadCounters();
                // loadCounters()ã§renderCounters()ãŒå‘¼ã°ã‚Œã‚‹ã®ã§ã€ãƒ•ã‚©ãƒ¼ãƒ å€¤ãŒæ¶ˆãˆãªã„ã‚ˆã†ã«å†è¨­å®š
                document.getElementById('counter-title').value = title;
                document.getElementById('counter-date').value = date;
                document.getElementById('counter-note').value = note;

                const type = detectCounterType(date);

                const exists = allCounters.some(c =>
                    c.title === title &&
                    c.date === date &&
                    (c.note || '') === note
                );
                if (exists) {
                    alert('åŒã˜å†…å®¹ã®ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ãŒæ—¢ã«å­˜åœ¨ã—ã¾ã™');
                    return;
                }

                const newCounter = {
                    title,
                    type,
                    date,
                    note: note || null,
                    created: new Date().toISOString()
                };

                allCounters.push(newCounter);

                const success = await saveToGitHub(allCounters, true);

                if (success) {
                    document.getElementById('counter-title').value = '';
                    document.getElementById('counter-note').value = '';
                    renderCounters();
                }
            } finally {
                addBtn.disabled = false;
            }
        }

        // ç·¨é›†ãƒ»å‰Šé™¤ãƒœã‚¿ãƒ³é–¢é€£ã®å‡¦ç†ã¯å‰Šé™¤

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¨­å®š
        document.addEventListener('DOMContentLoaded', () => {
            // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼è¿½åŠ ãƒœã‚¿ãƒ³
            document.getElementById('add-counter').addEventListener('click', addCounter);

            // æ¤œç´¢ãƒœãƒƒã‚¯ã‚¹
            document.getElementById('searchBox').addEventListener('input', (e) => {
                renderCounters(e.target.value.trim());
            });

            // ...existing code...
        });

        // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã®èª­ã¿è¾¼ã¿
        loadCounters();
    </script>
</body>

</html>