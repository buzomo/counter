
<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⏱️</text></svg>" />
    <title>カウントダウン・カウントアップ</title>
    <style>
        .container {
            max-width: 960px;
            margin: 0 auto;
            padding: 12px;
        }

        :root {
            --primary: #4e6cf2;
            --primary-hover: #3c53d6;
            --text: #333;
            --bg: #f5f7fa;
            --card-bg: #fff;
            --border: #e2e8f0;
            --shadow: rgba(0, 0, 0, 0.05);
            --shadow-hover: rgba(0, 0, 0, 0.08);
            --radius: 12px;
            --transition: all 0.2s ease;
            --countdown: #ff7e5f;
            --countup: #5fa3ff;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            font-weight: bold;
            font-size: 18px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", "Helvetica Neue", sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            max-width: 100%;
            width: 100%;
            margin: 0 auto;
        }

        .composer {
            background: var(--card-bg);
            border-radius: var(--radius);
            box-shadow: 0 2px 8px var(--shadow);
        }

        input {
            color: #2d6286;
        }

        input[type="text"],
        input[type="date"] {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            transition: var(--transition);
            font-family: inherit;
        }

        input[type="text"]:focus,
        input[type="date"]:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 2px rgba(78, 108, 242, 0.2);
        }

        select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--border);
            border-radius: var(--radius);
            transition: var(--transition);
            font-family: inherit;
            margin-bottom: 10px;
            background-color: white;
        }

        .btn {
            padding: 0.75rem 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: var(--radius);
            cursor: pointer;
            transition: var(--transition);
            width: 100%;
        }

        .btn:hover {
            background: var(--primary-hover);
        }

        .form-group {
            margin-bottom: 12px;
        }

        label {
            display: block;
            color: #4a5568;
        }

        #counters {
            display: grid;
            gap: 12px;
            grid-template-columns: 1fr;
            padding-top: 8px;
        }

        @media (min-width: 640px) {
            #counters {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 960px) {
            #counters {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        .counter {
            position: relative;
            padding: 16px;
            border-radius: var(--radius);
            background: var(--card-bg);
            box-shadow: 0 2px 5px var(--shadow);
            transition: var(--transition);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }

        .counter:hover {
            box-shadow: 0 5px 15px var(--shadow-hover);
            transform: translateY(-2px);
        }

        .counter-title {
            font-size: 1.2rem;
            font-weight: bold;
            color: #2d3748;
        }

        .counter-date {
            font-size: 0.9rem;
            color: #718096;
        }

        .counter-value {
            font-size: 1.8rem;
            font-weight: bold;
        }

        .countdown .counter-value {
            color: var(--countdown);
        }

        .countup .counter-value {
            color: var(--countup);
        }

        .counter-unit {
            font-size: 0.9rem;
            color: #718096;
        }

        .counter-actions {
            position: absolute;
            top: 12px;
            right: 12px;
            display: flex;
            gap: 8px;
        }

        .counter-btn {
            background: none;
            border: none;
            cursor: pointer;
            font-size: 1.2rem;
            color: #a0aec0;
            transition: var(--transition);
        }

        .counter-btn:hover {
            color: var(--primary);
        }

        #token-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(250, 250, 255, 0.95);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }

        #token-overlay input {
            padding: 0.5rem;
            font-size: 1rem;
            border: 1px solid #ccc;
            border-radius: 6px;
            width: 300px;
            max-width: 80%;
            margin-bottom: 1rem;
        }

        #token-overlay button {
            padding: 0.5rem 1rem;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 6px;
            font-size: 1rem;
            cursor: pointer;
        }

        .tab-controls {
            display: flex;
            border-radius: var(--radius);
            overflow: hidden;
            background: #e2e8f0;
        }

        .tab-btn {
            flex: 1;
            padding: 10px;
            text-align: center;
            background: none;
            border: none;
            cursor: pointer;
            transition: var(--transition);
        }

        .tab-btn.active {
            background: var(--primary);
            color: white;
        }

        .counter-note {
            font-size: 0.9rem;
            margin-top: 10px;
            color: #718096;
            font-style: italic;
        }

        .progress-bar {
            height: 6px;
            background: #e2e8f0;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            transition: width 0.3s ease;
        }

        .countdown .progress-fill {
            background: var(--countdown);
        }

        .countup .progress-fill {
            background: var(--countup);
        }

        .counter.expired {
            opacity: 0.6;
        }

        .counter-info-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-end;
            margin-bottom: 12px;
            gap: 8px;
        }

        .counter-info-left {
            text-align: left;
            flex: 1;
            color: #718096;
            font-size: 0.95rem;
            white-space: nowrap;
        }

        .counter-info-right {
            text-align: right;
            flex: 1;
            color: #718096;
            font-size: 0.95rem;
            white-space: nowrap;
        }
    </style>
</head>

<body>
        <a href="https://github.com/buzomo/counter/edit/main/index.html"
        style="text-decoration:none;position:fixed;right:13px;bottom:0;color:orange">edit now</a>
    <div id="token-overlay" style="display: none;">
        <input type="password" id="token-input" placeholder="GitHub Token を入力してください" />
        <button onclick="submitToken()">保存してリロード</button>
    </div>
    <div class="container">


        <div id="view-content">
            <div class="composer">
                <input id="searchBox" type="text" placeholder="検索..." />
            </div>
            <div id="counters"></div>
            <div id="add-content" style="display: none;">
                <div class="composer">
                    <div class="form-group">
                        <label for="counter-title">タイトル</label>
                        <input type="text" id="counter-title" placeholder="サブスク名や記念日など" />
                    </div>
                    <div class="form-group">
                        <label for="counter-date">日付</label>
                        <input type="date" id="counter-date" />
                    </div>
                    <div class="form-group">
                        <label for="counter-note">メモ (任意)</label>
                        <input type="text" id="counter-note" placeholder="メモを入力..." />
                    </div>
                    <button class="btn" id="add-counter">追加する</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // GitHub Token 関連
        if (!localStorage.getItem('gh_token')) {
            document.getElementById('token-overlay').style.display = 'flex';
            document.body.style.overflow = 'hidden';  // スクロール防止
        }

        function submitToken() {
            const token = document.getElementById('token-input').value.trim();
            if (token) {
                localStorage.setItem('gh_token', token);
                location.reload();
            }
        }

        let gh_token = localStorage.getItem('gh_token');
        try {
            const parsed = JSON.parse(gh_token);
            if (parsed?.value) gh_token = parsed.value;
        } catch { }
        if (gh_token) localStorage.setItem('gh_token', gh_token);

        // APIとデータの設定
        const apiUrl = 'https://api.github.com/repos/buzomo/bukome/contents/counter.json';
        let allCounters = [];
        // ソートは常に「残日数/経過日数順」
        let currentSort = 'value';


        // カウンターの読み込み
        async function loadCounters() {
            try {
                const res = await fetch(apiUrl, {
                    headers: {
                        Authorization: `Bearer ${gh_token}`
                    }
                });
                if (res.ok) {
                    const meta = await res.json();
                    // ファイルがあれば読み込む
                    if (meta.content) {
                        const decoded = decodeURIComponent(escape(atob(meta.content)));
                        allCounters = JSON.parse(decoded);
                    } else {
                        // ファイルがなければ空の配列
                        allCounters = [];
                    }
                } else {
                    if (res.status === 404) {
                        // ファイルが存在しない場合は空の配列
                        allCounters = [];
                    } else {
                        console.warn('読み込み失敗:', await res.text());
                        allCounters = [];
                    }
                }
            } catch (e) {
                console.warn('読み込み失敗:', e);
                allCounters = [];
            }

            // 重複排除処理
            if (Array.isArray(allCounters) && allCounters.length > 1) {
                const seen = new Set();
                const deduped = [];
                for (const c of allCounters) {
                    // キーはタイトル・日付・メモ（nullは空文字）
                    const key = `${c.title}__${c.date}__${c.note || ''}`;
                    if (!seen.has(key)) {
                        seen.add(key);
                        deduped.push(c);
                    }
                }
                if (deduped.length !== allCounters.length) {
                    allCounters = deduped;
                    // GitHubのデータを更新
                    await saveToGitHub(allCounters, true);
                }
            }

            renderCounters();
        }

        // GitHub にデータを保存（409エラー時は再取得してリトライ）
        async function saveToGitHub(data, skipRetryAdd = false) {
            let sha = null;
            try {
                const metaRes = await fetch(apiUrl, {
                    headers: { Authorization: `Bearer ${gh_token}` }
                });
                if (metaRes.ok) {
                    const meta = await metaRes.json();
                    sha = meta.sha;
                }
            } catch (e) {
                console.warn('sha取得失敗:', e);
            }

            const body = {
                message: 'Update counters',
                content: btoa(unescape(encodeURIComponent(JSON.stringify(data, null, 2))))
            };
            if (sha) body.sha = sha;

            try {
                const res = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        Authorization: `Bearer ${gh_token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(body)
                });

                if (!res.ok) {
                    // 409エラー時は1回だけリトライ
                    if (res.status === 409 && !skipRetryAdd) {
                        // 最新データを取得して再度追加・保存
                        await loadCounters();
                        // 直前の追加分が重複しないように再チェック
                        const title = document.getElementById('counter-title').value.trim();
                        const date = document.getElementById('counter-date').value;
                        const note = document.getElementById('counter-note').value.trim();
                        const exists = allCounters.some(c =>
                            c.title === title &&
                            c.date === date &&
                            (c.note || '') === note
                        );
                        if (!exists && title && date) {
                            // タイプ自動判別
                            const type = detectCounterType(date);
                            allCounters.push({
                                title,
                                type,
                                date,
                                note: note || null,
                                created: new Date().toISOString()
                            });
                        }
                        return await saveToGitHub(allCounters, true);
                    } else {
                        // 409以外やリトライ後はエラーを静かに無視
                        return false;
                    }
                }
                return true;
            } catch (e) {
                // エラーは静かに無視
                return false;
            }
        }

        // 日付の差分計算（日数）
        function getDaysDifference(dateStr) {
            const targetDate = new Date(dateStr);
            const today = new Date();

            // 時間部分をリセットして純粋に日付だけを比較
            today.setHours(0, 0, 0, 0);
            targetDate.setHours(0, 0, 0, 0);

            const diffTime = targetDate - today;
            return Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        }

        // 日付のフォーマット
        function formatDate(dateStr) {
            const d = new Date(dateStr);
            const year = d.getFullYear();
            const month = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            const weekdays = ['日', '月', '火', '水', '木', '金', '土'];
            const weekday = weekdays[d.getDay()];
            return `${year}年${month}月${day}日(${weekday})`;
        }

        // プログレスバーの計算（カウントダウン用）
        function calculateCountdownProgress(dateStr) {
            const targetDate = new Date(dateStr);
            const today = new Date();
            const createdDate = new Date();
            createdDate.setDate(today.getDate() - 30); // デフォルトで30日前から開始と仮定

            const totalDays = Math.ceil((targetDate - createdDate) / (1000 * 60 * 60 * 24));
            const remainingDays = Math.ceil((targetDate - today) / (1000 * 60 * 60 * 24));

            // 完了した割合を計算（0～100%）
            return Math.min(100, Math.max(0, ((totalDays - remainingDays) / totalDays) * 100));
        }

        // プログレスバーの計算（カウントアップ用）
        function calculateCountupProgress(dateStr) {
            const startDate = new Date(dateStr);
            const today = new Date();
            const futureDate = new Date(startDate);
            futureDate.setFullYear(startDate.getFullYear() + 1); // 1年後をゴールと仮定

            const totalDays = Math.ceil((futureDate - startDate) / (1000 * 60 * 60 * 24));
            const passedDays = Math.ceil((today - startDate) / (1000 * 60 * 60 * 24));

            // 完了した割合を計算（0～100%）
            return Math.min(100, Math.max(0, (passedDays / totalDays) * 100));
        }

        // タイプ自動判別関数
        function detectCounterType(date) {
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const target = new Date(date);
            target.setHours(0, 0, 0, 0);
            // 今日より未来→カウントダウン、今日または過去→カウントアップ
            return target > today ? 'countdown' : 'countup';
        }

        // 追加UIの表示制御
        function showAddUI(defaultTitle = '') {
            const addContent = document.getElementById('add-content');
            addContent.style.display = 'block';
            document.getElementById('counter-title').value = defaultTitle;
            document.getElementById('counter-date').valueAsDate = new Date();
            document.getElementById('counter-note').value = '';
            // ボタン状態リセット
            const addBtn = document.getElementById('add-counter');
            addBtn.textContent = '追加する';
            addBtn.onclick = addCounter;
        }
        function hideAddUI() {
            document.getElementById('add-content').style.display = 'none';
        }

        // カウンター表示
        function renderCounters(filterText = '') {
            const container = document.getElementById('counters');
            container.innerHTML = '';
            hideAddUI();

            if (!Array.isArray(allCounters) || allCounters.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:2rem;color:#718096;">カウンターがありません。下記フォームから追加してください。</div>';
                showAddUI(filterText);
                document.getElementById('searchBox').placeholder = '検索...（0件）';
                return;
            }

            // 検索フィルター
            let filtered = allCounters.filter(counter => {
                return counter.title.includes(filterText) ||
                    (counter.note && counter.note.includes(filterText));
            });

            // カウントダウン期限超過分とそれ以外で分ける
            const now = new Date();
            now.setHours(0, 0, 0, 0);
            let notExpired = [];
            let expired = [];
            filtered.forEach(counter => {
                if (
                    counter.type === 'countdown' &&
                    getDaysDifference(counter.date) < 0
                ) {
                    expired.push(counter);
                } else {
                    notExpired.push(counter);
                }
            });

            // ソート: notExpiredは通常の値順、expiredは期限超過日数が大きい順
            notExpired.sort((a, b) => {
                const daysA = getDaysDifference(a.date);
                const daysB = getDaysDifference(b.date);

                if (a.type === 'countdown' && b.type === 'countdown') {
                    return daysA - daysB;
                } else if (a.type === 'countup' && b.type === 'countup') {
                    return daysB - daysA;
                } else if (a.type === 'countdown' && b.type === 'countup') {
                    return -1;
                } else {
                    return 1;
                }
            });
            expired.sort((a, b) => {
                // 期限超過日数が大きいものほど後ろ
                return getDaysDifference(a.date) - getDaysDifference(b.date);
            });

            document.getElementById('searchBox').placeholder = `検索...（全${allCounters.length}件）`;

            let displayList = notExpired.concat(expired);
            displayList.forEach((counter, idx) => {
                const daysDiff = getDaysDifference(counter.date);
                const counterClass = counter.type === 'countdown' ? 'countdown' : 'countup';
                const expiredClass = (counter.type === 'countdown' && daysDiff < 0) ? 'expired' : '';

                let displayText = '';
                const dateStr = formatDate(counter.date);

                let unitHtml = '';
                if (counter.type === 'countdown') {
                    unitHtml = `<div class="counter-unit counter-info-right">${dateStr}まで</div>`;
                    if (daysDiff < 0) {
                        displayText = `${Math.abs(daysDiff)}日`;
                    } else if (daysDiff === 0) {
                        displayText = '今日';
                    } else {
                        displayText = `${daysDiff}日`;
                    }
                } else {
                    unitHtml = `<div class="counter-unit counter-info-left">${dateStr}から</div>`;
                    if (daysDiff > 0) {
                        displayText = 'あと';
                    } else if (daysDiff === 0) {
                        displayText = '今日';
                    } else {
                        displayText = `${Math.abs(daysDiff)}日`;
                    }
                }

                const progressPercent = counter.type === 'countdown'
                    ? calculateCountdownProgress(counter.date)
                    : calculateCountupProgress(counter.date);

                // 編集モード判定
                if (counter._editing) {
                    // 編集UI
                    const div = document.createElement('div');
                    div.className = `counter ${counterClass} ${expiredClass}`;
                    div.innerHTML = `
                        <input class="edit-title" type="text" value="${counter.title.replace(/"/g, '&quot;')}" style="margin-bottom:8px;">
                        <input class="edit-date" type="date" value="${counter.date.split('T')[0]}" style="margin-bottom:8px;">
                        <input class="edit-note" type="text" value="${counter.note ? counter.note.replace(/"/g, '&quot;') : ''}" placeholder="メモ" style="margin-bottom:8px;">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercent}%"></div>
                        </div>
                    `;
                    // Enterで保存
                    const saveEdit = async (e) => {
                        if (e.type === 'keydown' && e.key !== 'Enter') return;
                        const newTitle = div.querySelector('.edit-title').value.trim();
                        const newDate = div.querySelector('.edit-date').value;
                        const newNote = div.querySelector('.edit-note').value.trim();
                        if (!newTitle || !newDate) return;

                        // 変更がなければそのまま閲覧モードに戻す
                        if (
                            newTitle === counter.title &&
                            newDate === counter.date &&
                            (newNote || null) === (counter.note || null)
                        ) {
                            delete allCounters[idx]._editing;
                            renderCounters(document.getElementById('searchBox').value.trim());
                            return;
                        }

                        // 重複チェック（自分以外）
                        const exists = allCounters.some((c, i) =>
                            i !== idx &&
                            c.title === newTitle &&
                            c.date === newDate &&
                            (c.note || '') === newNote
                        );
                        if (exists) {
                            alert('同じ内容のカウンターが既に存在します');
                            return;
                        }
                        // 更新
                        allCounters[idx] = {
                            ...counter,
                            title: newTitle,
                            date: newDate,
                            note: newNote || null,
                            type: detectCounterType(newDate),
                            updated: new Date().toISOString(),
                        };
                        delete allCounters[idx]._editing;
                        await saveToGitHub(allCounters, true);
                        renderCounters(document.getElementById('searchBox').value.trim());
                    };
                    div.querySelector('.edit-title').addEventListener('keydown', saveEdit);
                    div.querySelector('.edit-date').addEventListener('keydown', saveEdit);
                    div.querySelector('.edit-note').addEventListener('keydown', saveEdit);
                    // フォーカス外れたら保存
                    div.querySelector('.edit-title').addEventListener('blur', saveEdit);
                    div.querySelector('.edit-date').addEventListener('blur', saveEdit);
                    div.querySelector('.edit-note').addEventListener('blur', saveEdit);
                    container.appendChild(div);
                    return;
                }

                // 通常表示
                const div = document.createElement('div');
                div.className = `counter ${counterClass} ${expiredClass}`;
                div.innerHTML = `
                    <div class="counter-title">${counter.title}</div>
                    <div class="counter-value">${displayText}</div>
                    ${unitHtml}
                    ${counter.note ? `<div class="counter-note">${counter.note}</div>` : ''}
                    <div class="progress-bar">
                        <div class="progress-fill" style="width: ${progressPercent}%"></div>
                    </div>
                `;
                // 右クリックで削除
                div.addEventListener('contextmenu', async (e) => {
                    e.preventDefault();
                    // idxは表示リストのindexなので、元配列のindexを特定
                    const realIdx = allCounters.findIndex(c =>
                        c.title === counter.title &&
                        c.date === counter.date &&
                        (c.note || '') === (counter.note || '')
                    );
                    if (realIdx !== -1) {
                        allCounters.splice(realIdx, 1);
                        await saveToGitHub(allCounters, true);
                        renderCounters(document.getElementById('searchBox').value.trim());
                    }
                });
                // ダブルクリックで編集
                div.addEventListener('dblclick', () => {
                    // idxは表示リストのindexなので、元配列のindexを特定
                    const realIdx = allCounters.findIndex(c =>
                        c.title === counter.title &&
                        c.date === counter.date &&
                        (c.note || '') === (counter.note || '')
                    );
                    if (realIdx !== -1) {
                        allCounters[realIdx]._editing = true;
                        renderCounters(document.getElementById('searchBox').value.trim());
                    }
                });
                container.appendChild(div);
            });

            if (filtered.length === 0) {
                container.innerHTML = '<div style="text-align:center;padding:2rem;color:#718096;">該当するカウンターがありません。下記フォームから追加できます。</div>';
                showAddUI(filterText);
            }
        }

        // カウンター追加
        async function addCounter() {
            const addBtn = document.getElementById('add-counter');
            if (addBtn.disabled) return; // すでに処理中なら何もしない
            addBtn.disabled = true;

            try {
                const title = document.getElementById('counter-title').value.trim();
                const date = document.getElementById('counter-date').value;
                const note = document.getElementById('counter-note').value.trim();

                if (!title) {
                    alert('タイトルを入力してください');
                    return;
                }

                if (!date) {
                    alert('日付を選択してください');
                    return;
                }

                // 最新データ取得してから重複チェック
                await loadCounters();
                // loadCounters()でrenderCounters()が呼ばれるので、フォーム値が消えないように再設定
                document.getElementById('counter-title').value = title;
                document.getElementById('counter-date').value = date;
                document.getElementById('counter-note').value = note;

                const type = detectCounterType(date);

                const exists = allCounters.some(c =>
                    c.title === title &&
                    c.date === date &&
                    (c.note || '') === note
                );
                if (exists) {
                    alert('同じ内容のカウンターが既に存在します');
                    return;
                }

                const newCounter = {
                    title,
                    type,
                    date,
                    note: note || null,
                    created: new Date().toISOString()
                };

                allCounters.push(newCounter);

                const success = await saveToGitHub(allCounters, true);

                if (success) {
                    document.getElementById('counter-title').value = '';
                    document.getElementById('counter-note').value = '';
                    renderCounters();
                }
            } finally {
                addBtn.disabled = false;
            }
        }

        // 編集・削除ボタン関連の処理は削除

        // イベントリスナーの設定
        document.addEventListener('DOMContentLoaded', () => {
            // カウンター追加ボタン
            document.getElementById('add-counter').addEventListener('click', addCounter);

            // 検索ボックス
            document.getElementById('searchBox').addEventListener('input', (e) => {
                renderCounters(e.target.value.trim());
            });

            // ...existing code...
        });

        // カウンターの読み込み
        loadCounters();
    </script>
</body>

</html>
